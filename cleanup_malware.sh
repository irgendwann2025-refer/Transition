#!/bin/bash
# Core Model: Gemini 3 Flash | Tier: Free
# Purpose: Identify and terminate cron-based persistence and linked network sockets.

if [[ $EUID -ne 0 ]]; then echo "Run as root."; exit 1; fi

LOG_FILE="/var/log/cron_security_audit.log"
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

echo "--- Security Audit Started: $TIMESTAMP ---" | tee -a "$LOG_FILE"

# 1. Identify suspicious cron jobs
SUSPICIOUS_CRONS=$(grep -rE "useradd|usermod|visudo|NOPASSWD" /etc/cron* /var/spool/cron/crontabs 2>/dev/null)

if [ -z "$SUSPICIOUS_CRONS" ]; then
    echo "No suspicious cron patterns detected." | tee -a "$LOG_FILE"
else
    echo "Suspicious Cron Jobs Found:" | tee -a "$LOG_FILE"
    echo "$SUSPICIOUS_CRONS" | tee -a "$LOG_FILE"
    FILES_TO_REMOVE=$(echo "$SUSPICIOUS_CRONS" | cut -d: -f1 | sort -u)

    for FILE in $FILES_TO_REMOVE; do
        mapfile -t TRIGGERED_APPS < <(grep -E "useradd|usermod" "$FILE" | awk '{print $NF}')
        for APP in "${TRIGGERED_APPS[@]}"; do
            if [ -f "$APP" ] || [ -x "$(command -v "$APP")" ]; then
                APP_NAME=$(basename "$APP")
                echo "Terminating processes and network for: $APP_NAME" | tee -a "$LOG_FILE"
                pkill -9 -f "$APP_NAME"
                lsof -i -n -P | grep "$APP_NAME" | awk '{print $2}' | xargs -r kill -9
            fi
        done
        rm -f "$FILE"
    done
fi

# 2. Final Sanity Check for UID 0
echo "Checking for unauthorized UID 0 users..." | tee -a "$LOG_FILE"
awk -F: '($3 == "0") {print $1}' /etc/passwd | grep -v "root" | tee -a "$LOG_FILE"
